import{C as S}from"./index-EOXgBHXE.js";import"./vendor-ui-CGZmARxJ.js";import"./vendor-react-qkC6yhPU.js";import"./vendor-utils-BGkSQjfT.js";import"./vendor-db-CzqAUFpF.js";const f="0vv2xlu9fdc0lxc",k="rgd4gih443nfvb0",u=window.location.origin,d="/Diary2Backup",g="diary_backup_",T=20;class b extends S{constructor(){super(),this.accessToken=null,this.refreshToken=null,this.tokenExpiresAt=null,this.authListeners=[],this.codeVerifier=null,this.restoreTokenFromStorage()}get providerName(){return"Dropbox"}get isAuthenticated(){return this.accessToken&&Date.now()<this.tokenExpiresAt}restoreTokenFromStorage(){try{const e=localStorage.getItem("dropbox_tokens");if(e){const{accessToken:t,refreshToken:r,expiresAt:o}=JSON.parse(e);this.accessToken=t,this.refreshToken=r,this.tokenExpiresAt=o,this.refreshToken&&Date.now()>=this.tokenExpiresAt&&this.refreshAccessToken()}}catch(e){console.error("Failed to restore Dropbox tokens:",e)}}saveTokenToStorage(){try{localStorage.setItem("dropbox_tokens",JSON.stringify({accessToken:this.accessToken,refreshToken:this.refreshToken,expiresAt:this.tokenExpiresAt}))}catch(e){console.error("Failed to save Dropbox tokens:",e)}}async initClient(){return Promise.resolve()}generateRandomString(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=new Uint8Array(e);return crypto.getRandomValues(r),Array.from(r).map(o=>t[o%t.length]).join("")}async sha256(e){const r=new TextEncoder().encode(e);return await crypto.subtle.digest("SHA-256",r)}base64URLEncode(e){const t=new Uint8Array(e);let r="";for(let o=0;o<t.length;o++)r+=String.fromCharCode(t[o]);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async signIn(){this.codeVerifier=this.generateRandomString(128);const e=await this.sha256(this.codeVerifier),t=this.base64URLEncode(e),r=this.generateRandomString(32);sessionStorage.setItem("dropbox_oauth_state",r),sessionStorage.setItem("dropbox_code_verifier",this.codeVerifier);const o=new URL("https://www.dropbox.com/oauth2/authorize");o.searchParams.set("client_id",f),o.searchParams.set("response_type","code"),o.searchParams.set("redirect_uri",u),o.searchParams.set("code_challenge",t),o.searchParams.set("code_challenge_method","S256"),o.searchParams.set("state",r),o.searchParams.set("token_access_type","offline");const i=600,n=700,c=window.screenX+(window.outerWidth-i)/2,h=window.screenY+(window.outerHeight-n)/2,s=window.open(o.toString(),"Dropbox Login",`width=${i},height=${n},left=${c},top=${h}`);return new Promise((a,l)=>{const m=setInterval(()=>{try{if(s.closed){clearInterval(m),l(new Error("Login cancelled"));return}const p=s.location.href;if(p.startsWith(u)){const w=new URL(p),_=w.searchParams.get("code"),x=w.searchParams.get("state");clearInterval(m),s.close();const y=sessionStorage.getItem("dropbox_oauth_state");if(x!==y){l(new Error("State mismatch - possible CSRF attack"));return}this.exchangeCodeForToken(_).then(a).catch(l)}}catch{}},500)})}async exchangeCodeForToken(e){const t=sessionStorage.getItem("dropbox_code_verifier");sessionStorage.removeItem("dropbox_oauth_state"),sessionStorage.removeItem("dropbox_code_verifier");const r=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({code:e,grant_type:"authorization_code",client_id:f,client_secret:k,redirect_uri:u,code_verifier:t})});if(!r.ok){const i=await r.json();throw new Error(`Token exchange failed: ${i.error_description||i.error}`)}const o=await r.json();this.accessToken=o.access_token,this.refreshToken=o.refresh_token,this.tokenExpiresAt=Date.now()+o.expires_in*1e3,this.saveTokenToStorage(),this.notifyAuthListeners(!0)}async refreshAccessToken(){if(!this.refreshToken)throw new Error("No refresh token available");const e=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:this.refreshToken,client_id:f,client_secret:k})});if(!e.ok)throw this.signOut(),new Error("Token refresh failed");const t=await e.json();this.accessToken=t.access_token,this.tokenExpiresAt=Date.now()+t.expires_in*1e3,this.saveTokenToStorage(),this.notifyAuthListeners(!0)}async restoreSession(e){if(console.log("Attempting to restore Dropbox session"),this.refreshToken)try{return await this.refreshAccessToken(),!0}catch(t){return console.log("Silent sign-in failed:",t),!1}return!1}async signOut(){if(this.accessToken)try{await fetch("https://api.dropboxapi.com/2/auth/token/revoke",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`}})}catch(e){console.error("Token revoke failed:",e)}this.accessToken=null,this.refreshToken=null,this.tokenExpiresAt=null,localStorage.removeItem("dropbox_tokens"),this.notifyAuthListeners(!1)}async getCurrentUser(){if(!this.isAuthenticated)return null;try{const e=await fetch("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`}});if(!e.ok)throw new Error("Failed to get user info");const t=await e.json();return{name:t.name.display_name,email:t.email,imageUrl:t.profile_photo_url||null}}catch(e){return console.error("Error getting user info:",e),null}}async listBackupFiles(){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");try{const e=await fetch("https://api.dropboxapi.com/2/files/list_folder",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({path:d,recursive:!1})});if(!e.ok){if(e.status===409)return[];throw new Error("Failed to list files")}return(await e.json()).entries.filter(o=>o[".tag"]==="file"&&o.name.startsWith(g)).map(o=>({id:o.id,name:o.name,createdTime:o.client_modified,modifiedTime:o.server_modified,size:o.size})).sort((o,i)=>new Date(i.createdTime)-new Date(o.createdTime))}catch(e){throw console.error("Error listing backup files:",e),e}}async uploadBackup(e,t,r){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");await this.createFolderIfNotExists();const o=new Date().toISOString().replace(/[:.]/g,"-"),i=`${g}${o}.zip`,n=`${d}/${i}`;return new Promise((c,h)=>{const s=new XMLHttpRequest;s.open("POST","https://content.dropboxapi.com/2/files/upload"),s.setRequestHeader("Authorization",`Bearer ${this.accessToken}`),s.setRequestHeader("Content-Type","application/octet-stream"),s.setRequestHeader("Dropbox-API-Arg",JSON.stringify({path:n,mode:"add",autorename:!1,mute:!1})),s.upload.onprogress=a=>{if(a.lengthComputable&&r){const l=a.loaded/a.total*100;r(l)}},s.onload=()=>{if(s.status>=200&&s.status<300){const a=JSON.parse(s.responseText);this.deleteOldBackups().then(()=>{c({file:{id:a.id,name:a.name,size:a.size},status:"created"})})}else{const a=JSON.parse(s.responseText);h(new Error(`Dropbox 업로드 실패: ${a.error_summary||s.statusText}`))}},s.onerror=()=>{h(new Error("네트워크 오류로 업로드에 실패했습니다."))},s.send(e)})}async downloadBackup(e,t){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");t&&t(10);let r=e;if(!e.startsWith("/")){const c=(await this.listBackupFiles()).find(h=>h.id===e);if(!c)throw new Error("파일을 찾을 수 없습니다.");r=`${d}/${c.name}`}t&&t(30);const o=await fetch("https://content.dropboxapi.com/2/files/download",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Dropbox-API-Arg":JSON.stringify({path:r})}});if(t&&t(60),!o.ok)throw new Error("파일 다운로드 실패");const i=await o.blob();return t&&t(100),{blob:i}}async deleteBackup(e){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");let t=e;if(!e.startsWith("/")){const i=(await this.listBackupFiles()).find(n=>n.id===e);if(!i)throw new Error("파일을 찾을 수 없습니다.");t=`${d}/${i.name}`}if(!(await fetch("https://api.dropboxapi.com/2/files/delete_v2",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({path:t})})).ok)throw new Error("파일 삭제 실패")}async deleteOldBackups(){try{const e=await this.listBackupFiles();if(e.length>T){const t=e.slice(T);console.log(`자동 정리: ${t.length}개의 오래된 백업을 삭제합니다.`);for(const r of t)await this.deleteBackup(r.id),console.log(`삭제 완료: ${r.name}`)}}catch(e){console.error("오래된 백업 파일 자동 삭제 실패:",e)}}async createFolderIfNotExists(){try{await fetch("https://api.dropboxapi.com/2/files/create_folder_v2",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({path:d,autorename:!1})})}catch{}}onAuthChange(e){return this.authListeners.push(e),e(this.isAuthenticated),()=>{this.authListeners=this.authListeners.filter(t=>t!==e)}}notifyAuthListeners(e){this.authListeners.forEach(t=>t(e))}}const $=new b;export{$ as dropboxService};
