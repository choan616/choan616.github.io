import{b as S,e as b,d as E}from"./index-BN9oKpQ0.js";import"./vendor-ui-CGZmARxJ.js";import"./vendor-react-qkC6yhPU.js";import"./vendor-utils-BGkSQjfT.js";import"./vendor-db-CzqAUFpF.js";const f="0vv2xlu9fdc0lxc",m="rgd4gih443nfvb0",u=window.location.origin,k="",g="Mmtm_backup_",y=20;class A extends S{constructor(){super(),this.accessToken=null,this.refreshToken=null,this.tokenExpiresAt=null,this.authListeners=[],this.codeVerifier=null,this.encryptionPassword=null,this.restoreTokenFromStorage()}get providerName(){return"Dropbox"}setEncryptionPassword(e){this.encryptionPassword=e}get isAuthenticated(){return this.accessToken&&Date.now()<this.tokenExpiresAt}restoreTokenFromStorage(){try{const e=localStorage.getItem("dropbox_tokens");if(e){const{accessToken:t,refreshToken:r,expiresAt:o}=JSON.parse(e);this.accessToken=t,this.refreshToken=r,this.tokenExpiresAt=o,this.refreshToken&&Date.now()>=this.tokenExpiresAt&&this.refreshAccessToken()}}catch(e){console.error("Failed to restore Dropbox tokens:",e)}}saveTokenToStorage(){try{localStorage.setItem("dropbox_tokens",JSON.stringify({accessToken:this.accessToken,refreshToken:this.refreshToken,expiresAt:this.tokenExpiresAt}))}catch(e){console.error("Failed to save Dropbox tokens:",e)}}async initClient(){return Promise.resolve()}generateRandomString(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=new Uint8Array(e);return crypto.getRandomValues(r),Array.from(r).map(o=>t[o%t.length]).join("")}async sha256(e){const r=new TextEncoder().encode(e);return await crypto.subtle.digest("SHA-256",r)}base64URLEncode(e){const t=new Uint8Array(e);let r="";for(let o=0;o<t.length;o++)r+=String.fromCharCode(t[o]);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async signIn(){this.codeVerifier=this.generateRandomString(128);const e=await this.sha256(this.codeVerifier),t=this.base64URLEncode(e),r=this.generateRandomString(32);sessionStorage.setItem("dropbox_oauth_state",r),sessionStorage.setItem("dropbox_code_verifier",this.codeVerifier);const o=new URL("https://www.dropbox.com/oauth2/authorize");o.searchParams.set("client_id",f),o.searchParams.set("response_type","code"),o.searchParams.set("redirect_uri",u),o.searchParams.set("code_challenge",t),o.searchParams.set("code_challenge_method","S256"),o.searchParams.set("state",r),o.searchParams.set("token_access_type","offline"),o.searchParams.set("scope","account_info.read files.content.read files.content.write");const a=600,c=700,l=window.screenX+(window.outerWidth-a)/2,p=window.screenY+(window.outerHeight-c)/2,i=window.open(o.toString(),"Dropbox Login",`width=${a},height=${c},left=${l},top=${p}`);return new Promise((h,s)=>{const n=setInterval(()=>{try{if(i.closed){clearInterval(n),s(new Error("Login cancelled"));return}const d=i.location.href;if(d.startsWith(u)){const w=new URL(d),T=w.searchParams.get("code"),_=w.searchParams.get("state");clearInterval(n),i.close();const x=sessionStorage.getItem("dropbox_oauth_state");if(_!==x){s(new Error("State mismatch - possible CSRF attack"));return}this.exchangeCodeForToken(T).then(h).catch(s)}}catch{}},500)})}async exchangeCodeForToken(e){const t=sessionStorage.getItem("dropbox_code_verifier");sessionStorage.removeItem("dropbox_oauth_state"),sessionStorage.removeItem("dropbox_code_verifier");const r=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({code:e,grant_type:"authorization_code",client_id:f,client_secret:m,redirect_uri:u,code_verifier:t})});if(!r.ok){const a=await r.json();throw new Error(`Token exchange failed: ${a.error_description||a.error}`)}const o=await r.json();this.accessToken=o.access_token,this.refreshToken=o.refresh_token,this.tokenExpiresAt=Date.now()+o.expires_in*1e3,this.saveTokenToStorage(),this.notifyAuthListeners(!0)}async refreshAccessToken(){if(!this.refreshToken)throw new Error("No refresh token available");const e=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:this.refreshToken,client_id:f,client_secret:m})});if(!e.ok)throw this.signOut(),new Error("Token refresh failed");const t=await e.json();this.accessToken=t.access_token,this.tokenExpiresAt=Date.now()+t.expires_in*1e3,this.saveTokenToStorage(),this.notifyAuthListeners(!0)}async restoreSession(e){if(this.refreshToken)try{return await this.refreshAccessToken(),!0}catch(t){return console.log("Silent sign-in failed:",t),!1}return!1}async signOut(){if(this.accessToken)try{await fetch("https://api.dropboxapi.com/2/auth/token/revoke",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`}})}catch(e){console.error("Token revoke failed:",e)}this.accessToken=null,this.refreshToken=null,this.tokenExpiresAt=null,localStorage.removeItem("dropbox_tokens"),this.notifyAuthListeners(!1)}async getCurrentUser(){if(!this.isAuthenticated)return null;try{const e=await fetch("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`}});if(!e.ok)throw new Error("Failed to get user info");const t=await e.json();return{name:t.name.display_name,email:t.email,imageUrl:t.profile_photo_url||null}}catch(e){return console.error("Error getting user info:",e),null}}async listBackupFiles(){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");try{const e=await fetch("https://api.dropboxapi.com/2/files/list_folder",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({path:k,recursive:!1})});if(!e.ok){if(e.status===409)return[];throw new Error("Failed to list files")}return(await e.json()).entries.filter(r=>r[".tag"]==="file"&&r.name.startsWith(g)).map(r=>({id:r.id,name:r.name,createdTime:r.client_modified,modifiedTime:r.server_modified,size:r.size})).sort((r,o)=>new Date(o.createdTime)-new Date(r.createdTime))}catch(e){throw console.error("Error listing backup files:",e),e}}async uploadBackup(e,t,r){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");await this.createFolderIfNotExists();let o=e,a="zip";if(this.encryptionPassword)try{const i=await e.arrayBuffer(),h=await b(i,this.encryptionPassword);o=new Blob([h],{type:"application/octet-stream"}),a="enc",console.log("Dropbox: 데이터가 암호화되어 업로드됩니다.")}catch(i){throw new Error("백업 암호화 중 오류 발생: "+i.message)}const c=new Date().toISOString().replace(/[:.]/g,"-"),l=`${g}${c}.${a}`,p=`${k}/${l}`;return new Promise((i,h)=>{const s=new XMLHttpRequest;s.open("POST","https://content.dropboxapi.com/2/files/upload"),s.setRequestHeader("Authorization",`Bearer ${this.accessToken}`),s.setRequestHeader("Content-Type","application/octet-stream"),s.setRequestHeader("Dropbox-API-Arg",JSON.stringify({path:p,mode:"add",autorename:!1,mute:!1})),s.upload.onprogress=n=>{if(n.lengthComputable&&r){const d=n.loaded/n.total*100;r(d)}},s.onload=()=>{if(s.status>=200&&s.status<300){const n=JSON.parse(s.responseText);this.deleteOldBackups().then(()=>{i({file:{id:n.id,name:n.name,size:n.size,modifiedTime:n.server_modified},status:"created"})})}else h(new Error(`Dropbox 업로드 실패: ${s.responseText}`))},s.onerror=()=>h(new Error("네트워크 오류로 업로드에 실패했습니다.")),s.send(o)})}async downloadBackup(e,t){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");t&&t(10);const r=await fetch("https://content.dropboxapi.com/2/files/download",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Dropbox-API-Arg":JSON.stringify({path:e})}});if(!r.ok)throw new Error("파일 다운로드 실패");let o=await r.blob();if(t&&t(80),e.endsWith(".enc")){if(!this.encryptionPassword){const a=new Error("암호화된 백업입니다. 설정에서 비밀번호를 입력해주세요.");throw a.code="PASSWORD_REQUIRED",a}try{const a=await o.arrayBuffer(),c=await E(a,this.encryptionPassword);o=new Blob([c],{type:"application/zip"})}catch{throw new Error("복호화 실패: 비밀번호가 틀렸거나 파일이 손상되었습니다.")}}return t&&t(100),{blob:o}}async getSyncFileMetadata(){const e=await this.listBackupFiles();return e.length>0?e[0]:null}async getSyncData(){const e=await this.getSyncFileMetadata();if(!e)return null;const{blob:t}=await this.downloadBackup(e.id);return{...e,blob:t}}async deleteBackup(e){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");const t=await fetch("https://api.dropboxapi.com/2/files/delete_v2",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({path:e})});if(!t.ok){const r=await t.json();throw new Error(`파일 삭제 실패: ${r.error_summary}`)}}async deleteOldBackups(){try{const e=await this.listBackupFiles();if(e.length>y){const t=e.slice(y);for(const r of t)await this.deleteBackup(r.id)}}catch(e){console.error("Dropbox: 오래된 백업 삭제 실패:",e)}}async createFolderIfNotExists(){}onAuthChange(e){return this.authListeners.push(e),e(this.isAuthenticated),()=>{this.authListeners=this.authListeners.filter(t=>t!==e)}}notifyAuthListeners(e){this.authListeners.forEach(t=>t(e))}}const O=new A;export{O as dropboxService};
