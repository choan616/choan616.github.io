import{b as S}from"./index-DBvPR6_b.js";import"./vendor-ui-CGZmARxJ.js";import"./vendor-react-qkC6yhPU.js";import"./vendor-utils-BGkSQjfT.js";import"./vendor-db-CzqAUFpF.js";const p="0vv2xlu9fdc0lxc",k="rgd4gih443nfvb0",f=window.location.origin,u="/Diary2Backup",g="diary_backup_",T=20;class b extends S{constructor(){super(),this.accessToken=null,this.refreshToken=null,this.tokenExpiresAt=null,this.authListeners=[],this.codeVerifier=null,this.restoreTokenFromStorage()}get providerName(){return"Dropbox"}get isAuthenticated(){return this.accessToken&&Date.now()<this.tokenExpiresAt}restoreTokenFromStorage(){try{const e=localStorage.getItem("dropbox_tokens");if(e){const{accessToken:t,refreshToken:o,expiresAt:r}=JSON.parse(e);this.accessToken=t,this.refreshToken=o,this.tokenExpiresAt=r,this.refreshToken&&Date.now()>=this.tokenExpiresAt&&this.refreshAccessToken()}}catch(e){console.error("Failed to restore Dropbox tokens:",e)}}saveTokenToStorage(){try{localStorage.setItem("dropbox_tokens",JSON.stringify({accessToken:this.accessToken,refreshToken:this.refreshToken,expiresAt:this.tokenExpiresAt}))}catch(e){console.error("Failed to save Dropbox tokens:",e)}}async initClient(){return Promise.resolve()}generateRandomString(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",o=new Uint8Array(e);return crypto.getRandomValues(o),Array.from(o).map(r=>t[r%t.length]).join("")}async sha256(e){const o=new TextEncoder().encode(e);return await crypto.subtle.digest("SHA-256",o)}base64URLEncode(e){const t=new Uint8Array(e);let o="";for(let r=0;r<t.length;r++)o+=String.fromCharCode(t[r]);return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async signIn(){this.codeVerifier=this.generateRandomString(128);const e=await this.sha256(this.codeVerifier),t=this.base64URLEncode(e),o=this.generateRandomString(32);sessionStorage.setItem("dropbox_oauth_state",o),sessionStorage.setItem("dropbox_code_verifier",this.codeVerifier);const r=new URL("https://www.dropbox.com/oauth2/authorize");r.searchParams.set("client_id",p),r.searchParams.set("response_type","code"),r.searchParams.set("redirect_uri",f),r.searchParams.set("code_challenge",t),r.searchParams.set("code_challenge_method","S256"),r.searchParams.set("state",o),r.searchParams.set("token_access_type","offline"),r.searchParams.set("scope","account_info.read files.content.read files.content.write");const a=600,c=700,l=window.screenX+(window.outerWidth-a)/2,h=window.screenY+(window.outerHeight-c)/2,s=window.open(r.toString(),"Dropbox Login",`width=${a},height=${c},left=${l},top=${h}`);return new Promise((n,i)=>{const m=setInterval(()=>{try{if(s.closed){clearInterval(m),i(new Error("Login cancelled"));return}const d=s.location.href;if(d.startsWith(f)){const w=new URL(d),_=w.searchParams.get("code"),x=w.searchParams.get("state");clearInterval(m),s.close();const y=sessionStorage.getItem("dropbox_oauth_state");if(x!==y){i(new Error("State mismatch - possible CSRF attack"));return}this.exchangeCodeForToken(_).then(n).catch(i)}}catch{}},500)})}async exchangeCodeForToken(e){const t=sessionStorage.getItem("dropbox_code_verifier");sessionStorage.removeItem("dropbox_oauth_state"),sessionStorage.removeItem("dropbox_code_verifier");const o=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({code:e,grant_type:"authorization_code",client_id:p,client_secret:k,redirect_uri:f,code_verifier:t})});if(!o.ok){const a=await o.json();throw new Error(`Token exchange failed: ${a.error_description||a.error}`)}const r=await o.json();this.accessToken=r.access_token,this.refreshToken=r.refresh_token,this.tokenExpiresAt=Date.now()+r.expires_in*1e3,this.saveTokenToStorage(),this.notifyAuthListeners(!0)}async refreshAccessToken(){if(!this.refreshToken)throw new Error("No refresh token available");const e=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:this.refreshToken,client_id:p,client_secret:k})});if(!e.ok)throw this.signOut(),new Error("Token refresh failed");const t=await e.json();this.accessToken=t.access_token,this.tokenExpiresAt=Date.now()+t.expires_in*1e3,this.saveTokenToStorage(),this.notifyAuthListeners(!0)}async restoreSession(e){if(console.log("Attempting to restore Dropbox session"),this.refreshToken)try{return await this.refreshAccessToken(),!0}catch(t){return console.log("Silent sign-in failed:",t),!1}return!1}async signOut(){if(this.accessToken)try{await fetch("https://api.dropboxapi.com/2/auth/token/revoke",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`}})}catch(e){console.error("Token revoke failed:",e)}this.accessToken=null,this.refreshToken=null,this.tokenExpiresAt=null,localStorage.removeItem("dropbox_tokens"),this.notifyAuthListeners(!1)}async getCurrentUser(){if(!this.isAuthenticated)return null;try{const e=await fetch("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`}});if(!e.ok)throw new Error("Failed to get user info");const t=await e.json();return{name:t.name.display_name,email:t.email,imageUrl:t.profile_photo_url||null}}catch(e){return console.error("Error getting user info:",e),null}}async listBackupFiles(){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");try{const e=await fetch("https://api.dropboxapi.com/2/files/list_folder",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({path:u,recursive:!1})});if(!e.ok){if(e.status===409)return[];throw new Error("Failed to list files")}return(await e.json()).entries.filter(r=>r[".tag"]==="file"&&r.name.startsWith(g)).map(r=>({id:r.id,name:r.name,createdTime:r.client_modified,modifiedTime:r.server_modified,size:r.size})).sort((r,a)=>new Date(a.createdTime)-new Date(r.createdTime))}catch(e){throw console.error("Error listing backup files:",e),e}}async uploadBackup(e,t,o){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");await this.createFolderIfNotExists();const r=new Date().toISOString().replace(/[:.]/g,"-"),a=`${g}${r}.zip`,c=`${u}/${a}`;return new Promise((l,h)=>{const s=new XMLHttpRequest;s.open("POST","https://content.dropboxapi.com/2/files/upload"),s.setRequestHeader("Authorization",`Bearer ${this.accessToken}`),s.setRequestHeader("Content-Type","application/octet-stream"),s.setRequestHeader("Dropbox-API-Arg",JSON.stringify({path:c,mode:"add",autorename:!1,mute:!1})),s.upload.onprogress=n=>{if(n.lengthComputable&&o){const i=n.loaded/n.total*100;o(i)}},s.onload=()=>{if(s.status>=200&&s.status<300){let n;try{n=JSON.parse(s.responseText)}catch{console.warn("Dropbox 업로드 응답이 JSON 형식이 아닙니다:",s.responseText),n={id:a,name:a,size:e.size}}this.deleteOldBackups().then(()=>{l({file:{id:n.id||a,name:n.name||a,size:n.size||e.size},status:"created"})})}else{let n=s.statusText;try{const i=JSON.parse(s.responseText);n=i.error_summary||i.error||i.error_description||s.responseText}catch{n=s.responseText||s.statusText}h(new Error(`Dropbox 업로드 실패 (${s.status}): ${n}`))}},s.onerror=()=>{h(new Error("네트워크 오류로 업로드에 실패했습니다."))},s.send(e)})}async downloadBackup(e,t){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");t&&t(10);const o=e;t&&t(30);const r=await fetch("https://content.dropboxapi.com/2/files/download",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Dropbox-API-Arg":JSON.stringify({path:o})}});if(t&&t(60),!r.ok){const c=await r.text();throw new Error(`파일 다운로드 실패: ${c}`)}const a=await r.blob();return t&&t(100),{blob:a}}async deleteBackup(e){if(!this.isAuthenticated)throw new Error("로그인이 필요합니다.");const t=e;console.log(`Dropbox 파일 삭제 요청: ${t}`);const o=await fetch("https://api.dropboxapi.com/2/files/delete_v2",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({path:t})});if(!o.ok){const r=await o.json();throw new Error(`파일 삭제 실패: ${r.error_summary||o.statusText}`)}}async deleteOldBackups(){try{const e=await this.listBackupFiles();if(e.length>T){const t=e.slice(T);console.log(`자동 정리: ${t.length}개의 오래된 백업을 삭제합니다.`);for(const o of t)await this.deleteBackup(o.id),console.log(`삭제 완료: ${o.name}`)}}catch(e){console.error("오래된 백업 파일 자동 삭제 실패:",e)}}async createFolderIfNotExists(){try{const e=await fetch("https://api.dropboxapi.com/2/files/create_folder_v2",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({path:u,autorename:!1})});if(!e.ok){const t=await e.json();if(t.error&&t.error[".tag"]==="path"&&t.error.path[".tag"]==="conflict")return;throw console.error("폴더 생성 실패:",t),new Error(`폴더 생성 실패: ${t.error_summary||e.statusText}`)}}catch(e){if(e.message&&e.message.includes("conflict"))return;console.warn("백업 폴더 생성 중 오류 (이미 존재할 수 있음):",e)}}onAuthChange(e){return this.authListeners.push(e),e(this.isAuthenticated),()=>{this.authListeners=this.authListeners.filter(t=>t!==e)}}notifyAuthListeners(e){this.authListeners.forEach(t=>t(e))}}const I=new b;export{I as dropboxService};
